<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hours For Shelby</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #F3EAD3;
            --bg-secondary: #FFFFFF;
            --text-primary: #4A4A4A;
            --text-secondary: #7A7A7A;
            --accent-primary: #86A8E7;
            --accent-secondary: #91EAE4;
            --border-default: #D9D9D9;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.5s ease, color 0.5s ease; }
        .card { background-color: var(--bg-secondary); border-radius: 1.5rem; box-shadow: 0 10px 25px -5px var(--shadow-color), 0 8px 10px -6px var(--shadow-color); transition: background-color 0.5s ease, box-shadow 0.5s ease; }
        .btn { border-radius: 0.75rem; transition: transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border-color: transparent; }
        .btn-secondary { background-color: transparent; border: 1px solid var(--accent-primary); color: var(--accent-primary); }
        .btn-danger { background-color: #E74C3C; color: white; border-color: transparent; }
        .input-field { background-color: var(--bg-primary); border: 1px solid transparent; border-radius: 0.75rem; transition: background-color 0.3s ease, border-color 0.3s ease; padding: 0.5rem 0.75rem; cursor: text; }
        .input-field:focus { outline: none; border-color: var(--accent-primary); background-color: var(--bg-secondary); }
        #notification-toast { position: fixed; bottom: 1.25rem; right: 1.25rem; z-index: 100; opacity: 0; transform: translateY(2rem); transition: opacity 0.3s ease, transform 0.3s ease; }
        #notification-toast.show { opacity: 1; transform: translateY(0); }
        #timesheet-output { font-family: 'Courier New', Courier, monospace; white-space: pre; background-color: var(--bg-primary); }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.7); opacity: 0; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s ease-out; }
        .modal-backdrop.active .modal-content { transform: scale(1); opacity: 1; }

        /* --- Side Panel --- */
        #side-panel-container { position: fixed; top: 0; right: 0; bottom: 0; left: 0; z-index: 40; pointer-events: none; }
        #side-panel-backdrop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s ease-in-out; }
        #side-panel-content { position: absolute; top: 0; right: 0; height: 100%; width: 90%; max-width: 400px; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        #side-panel-container.active { pointer-events: auto; }
        #side-panel-container.active #side-panel-backdrop { opacity: 1; }
        #side-panel-container.active #side-panel-content { transform: translateX(0); }

        /* --- Animated Backgrounds --- */
        #background-animation-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden; }
        .animated-gradient { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradient 15s ease infinite; }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .orb { position: absolute; bottom: -200px; background-color: rgba(134, 168, 231, 0.2); border-radius: 50%; animation: rise 20s infinite linear; }
        @keyframes rise { 0% { transform: translateY(0); } 100% { transform: translateY(-120vh); } }
        .star { position: absolute; background-color: white; border-radius: 50%; animation: twinkle 5s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0; } 50% { opacity: 0.8; } }

        /* --- Achievement Notification --- */
        #achievement-toast {
            position: fixed;
            top: 1.25rem;
            left: 50%;
            transform: translate(-50%, -150%);
            z-index: 101;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #achievement-toast.show {
            transform: translate(-50%, 0);
        }
        #achievement-icon { font-size: 1.75rem; }
        #achievement-details h4 { font-weight: 700; }
        #achievement-details p { font-size: 0.875rem; opacity: 0.9; }
        
        /* --- Splash Screen --- */
        #splash-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }
        #splash-title span {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
            animation: title-fade-in 0.5s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes title-fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        #splash-clock-container {
            position: relative;
            width: 64px;
            height: 64px;
        }
        
        .splash-cog {
            transform-origin: center;
            animation: spin 2s linear infinite;
            transition: opacity 0.5s ease-in-out;
        }
        .splash-clock-face, .splash-clock-hands {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .splash-cog.fade-out {
            opacity: 0;
        }
        .splash-clock-face.fade-in, .splash-clock-hands.fade-in {
            opacity: 1;
        }
        
        .minute-hand, .hour-hand {
            transform-origin: center;
        }
        .minute-hand.spinning {
            animation: spin-hand 60s linear infinite;
        }
        .hour-hand.spinning {
            animation: spin-hand 720s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes spin-hand {
             from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #splash-start-btn {
            opacity: 0;
            animation: fade-in 0.5s forwards 2.5s;
        }
        @keyframes fade-in {
            to { opacity: 1; }
        }

        /* --- Timecard Popup --- */
        #timecard-popup {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translate(-50%, 150%); /* Start off-screen below */
            z-index: 102; /* Above other elements */
            width: 90%;
            max-width: 350px;
            padding: 1.5rem 2rem;
            text-align: center;
            transition: transform 0.4s cubic-bezier(0.215, 0.610, 0.355, 1);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        #timecard-popup.show {
            transform: translate(-50%, 0); /* Slide into view */
        }
        #timecard-status {
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        #timecard-time {
            font-size: 1.25rem; /* 20px */
            color: var(--accent-primary);
            font-weight: 500;
        }

    </style>
</head>
<body class="antialiased">

    <div id="splash-screen" class="fixed inset-0 bg-[var(--bg-primary)] z-[100] transition-opacity duration-500">
        <h1 id="splash-title" class="text-4xl font-bold tracking-tight text-[var(--text-primary)]"></h1>
        <div id="splash-clock-container">
             <svg class="absolute inset-0 h-full w-full" viewBox="0 0 24 24">
                <g class="splash-cog">
                    <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="1.5"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" fill="none" stroke="currentColor" stroke-width="1.5"></path>
                </g>
                <circle class="splash-clock-face" cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.5"></circle>
                <g class="splash-clock-hands">
                    <line class="minute-hand" x1="12" y1="12" x2="12" y2="5" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                    <line class="hour-hand" x1="12" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                </g>
            </svg>
        </div>
        <button id="splash-start-btn" class="btn btn-primary font-bold py-3 px-8 text-lg">Start</button>
        <p class="absolute bottom-6 text-sm text-[var(--text-secondary)] opacity-50">1.0</p>
    </div>

    <div id="background-animation-container"></div>

    <div class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-5xl mx-auto">

            <div class="flex justify-center items-center gap-4 sm:gap-8 mb-8">
                <button id="clock-in-btn" class="btn btn-primary flex-1 max-w-xs py-4 px-6 text-xl font-bold shadow-lg flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sunrise"><path d="M17 18a5 5 0 0 0-10 0"></path><line x1="12" y1="2" x2="12" y2="9"></line><line x1="4.22" y1="10.22" x2="5.64" y2="8.8"></line><line x1="1" y1="18" x2="3" y2="18"></line><line x1="21" y1="18" x2="23" y2="18"></line><line x1="18.36" y1="8.8" x2="19.78" y2="10.22"></line><line x1="12" y1="23" x2="12" y2="18"></line><polyline points="16 5 12 9 8 5"></polyline></svg>
                    <span>Clock In</span>
                </button>
                <button id="clock-out-btn" class="btn btn-secondary flex-1 max-w-xs py-4 px-6 text-xl font-bold shadow-lg flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sunset"><path d="M17 18a5 5 0 0 0-10 0"></path><line x1="12" y1="9" x2="12" y2="2"></line><line x1="4.22" y1="10.22" x2="5.64" y2="8.8"></line><line x1="1" y1="18" x2="3" y2="18"></line><line x1="21" y1="18" x2="23" y2="18"></line><line x1="18.36" y1="8.8" x2="19.78" y2="10.22"></line><line x1="12" y1="23" x2="12" y2="18"></line><polyline points="16 5 12 9 8 5"></polyline></svg>
                    <span>Clock Out</span>
                </button>
            </div>

            <main class="space-y-8">
                <div id="calendar-card" class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-black/10 transition-colors">&lt;</button>
                        <h2 id="month-year-header" class="text-xl font-bold"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-black/10 transition-colors">&gt;</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center max-w-md mx-auto"></div>
                </div>

                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Summary</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-secondary">Today</p>
                            <p id="summary-today" class="text-2xl font-bold">0.00h</p>
                        </div>
                        <div>
                            <p class="text-sm text-secondary">Pay Period</p>
                            <p id="summary-pay-period" class="text-2xl font-bold">0.00h</p>
                        </div>
                        <div>
                            <p class="text-sm text-secondary">Total</p>
                            <p id="summary-total" class="text-2xl font-bold">0.00h</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center flex-wrap gap-4">
                     <button id="turn-in-hours-btn" class="btn btn-primary font-bold py-3 px-8 text-lg">Turn In Hours</button>
                     <button id="view-stats-btn" class="btn btn-secondary font-bold py-3 px-8 text-lg">View Stats</button>
                     <button id="settings-btn" class="btn btn-secondary font-bold py-3 px-8 text-lg">Settings</button>
                </div>
            </main>
        </div>
    </div>

    <div id="side-panel-container">
        <div id="side-panel-backdrop"></div>
        <div id="side-panel-content" class="card !rounded-l-3xl !rounded-r-none p-6 flex flex-col">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold">Selected Day</h3>
                <button id="close-side-panel-btn" class="p-2 rounded-full hover:bg-black/10 transition-colors">&times;</button>
            </div>
            <p id="display-selected-date" class="text-sm text-secondary mb-6">Select a date</p>

            <div class="flex-grow overflow-y-auto pr-2">
                <button id="add-session-btn" title="Add New Session" class="w-full btn btn-secondary mb-4">
                    Add Session
                </button>
                <div id="sessions-display-area" class="space-y-3 mb-4">
                </div>
                <div id="additional-hours-display-area" class="space-y-2 mb-4">
                    </div>
            </div>

            <hr class="my-4 border-dashed">
            <div class="flex justify-between items-center">
                <span class="font-bold text-lg">Total for Day:</span>
                <span id="display-day-total" class="font-bold text-xl" style="color: var(--accent-primary);">0.00h</span>
            </div>
            <p id="no-hours-message" class="text-center text-secondary py-8 hidden">No hours logged for this day.</p>
        </div>
    </div>


    <div id="time-entry-modal" class="modal-backdrop">
        <div class="modal-content card w-full max-w-md m-4 p-6">
             <div class="flex justify-between items-center mb-4">
                 <h3 id="modal-title" class="text-lg font-semibold">Log Hours</h3>
                 <button id="close-entry-modal-btn" class="p-2 rounded-full hover:bg-black/10 transition-colors">&times;</button>
             </div>
            <p id="modal-selected-date" class="text-sm text-secondary mb-6"></p>
            <div class="space-y-6">
                <div id="time-in-container"> <label class="text-sm font-medium">Time In</label> <input id="time-in" type="time" class="input-field w-full mt-1"> </div>
                <div id="time-out-container"> <label class="text-sm font-medium">Time Out</label> <input id="time-out" type="time" class="input-field w-full mt-1"> </div>
                <div id="hour-type-container"> <label class="text-sm font-medium mb-2 block">Type</label> <div class="grid grid-cols-2 gap-2"> <button data-type="CORE" class="hour-type-btn btn font-semibold py-2">CORE</button> <button data-type="ACAP" class="hour-type-btn btn font-semibold py-2">ACAP</button> </div> </div>
                <div id="additional-hours-container"> <label class="text-sm font-medium">Additional Hours (optional)</label> <input id="additional-hours" type="number" step="0.01" placeholder="e.g., 1.5" class="input-field w-full mt-1"> </div>
                <button id="save-btn" class="btn btn-primary w-full py-3 font-bold !mt-8">Save Hours</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content card w-full max-w-md m-4 max-h-[90vh] overflow-y-auto p-6 relative">
            <div class="text-center mb-6">
                 <h2 class="text-2xl font-bold text-[var(--text-primary)]">Hours for Shelby</h2>
                 <p class="text-lg text-[var(--text-secondary)]">Settings</p>
            </div>
            <button id="close-settings-modal-btn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-black/10 transition-colors">&times;</button>
            <div class="space-y-6">
                <div><label for="theme-select" class="block text-sm font-medium mb-1">Color Theme</label><select id="theme-select" class="input-field w-full"></select></div>
                <div><label for="background-select" class="block text-sm font-medium mb-1">Animated Background</label><select id="background-select" class="input-field w-full">
                    <option value="none">None</option>
                    <option value="gradient">Animated Gradient</option>
                    <option value="orbs">Floating Orbs</option>
                    <option value="stars">Starry Night</option>
                </select></div>
                <div><label for="pay-period-select" class="block text-sm font-medium mb-1">Pay Period</label><select id="pay-period-select" class="input-field w-full"><option value="7">Weekly</option><option value="14" selected>Bi-Weekly</option><option value="15">Semi-Monthly</option><option value="30">Monthly</option></select></div>
                <button id="clear-data-btn" class="btn btn-danger w-full py-2">Clear All Data</button>
            </div>
        </div>
    </div>
    
    <div id="stats-modal" class="modal-backdrop">
        <div class="modal-content card w-full max-w-3xl m-4 max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Historical Stats</h2>
                <button id="close-stats-modal-btn" class="p-2 rounded-full hover:bg-black/10 transition-colors">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="md:col-span-2">
                    <canvas id="weekly-hours-chart"></canvas>
                </div>
                <div>
                    <canvas id="type-breakdown-chart"></canvas>
                </div>
                 <div id="stats-no-data-message" class="text-center text-secondary py-8 hidden">
                     <p>Log some more hours to see your stats here.</p>
                 </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content card w-full max-w-sm m-4 p-6 text-center">
            <h3 id="confirm-message" class="text-lg font-medium mb-6">Are you sure?</h3>
            <div class="flex justify-center gap-4"> <button id="confirm-cancel-btn" class="btn btn-secondary w-full py-2">Cancel</button> <button id="confirm-ok-btn" class="btn btn-danger w-full py-2">Confirm</button> </div>
        </div>
    </div>

    <div id="clock-out-type-modal" class="modal-backdrop">
        <div class="modal-content card w-full max-w-sm m-4 p-6 text-center">
            <h3 class="text-lg font-medium mb-6">What type of hours?</h3>
            <div class="flex flex-col gap-4">
                <button id="confirm-acap-btn" class="btn btn-primary w-full py-3 font-bold">ACAP</button>
                <button id="confirm-core-btn" class="btn btn-primary w-full py-3 font-bold">CORE</button>
                <button id="clock-out-cancel-btn" class="btn btn-secondary w-full py-2 mt-2">Cancel</button>
            </div>
        </div>
    </div>

    <div id="timesheet-modal" class="modal-backdrop">
        <div class="modal-content card w-full max-w-lg m-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Generated Timesheet</h3>
                <button id="close-timesheet-modal-btn" class="p-2 rounded-full hover:bg-black/10 transition-colors">&times;</button>
            </div>
            <textarea id="timesheet-output" readonly class="w-full h-64 p-2 border rounded-lg input-field resize-none"></textarea>
            <div class="flex flex-col gap-4 mt-4">
                <button id="copy-timesheet-btn" class="btn btn-primary w-full py-2">Copy Timesheet</button>
                <button id="close-timesheet-btn-bottom" class="btn btn-secondary w-full py-2">Close Window</button>
            </div>
        </div>
    </div>

    <div id="notification-toast" class="card py-3 px-5"> <p id="notification-message"></p> </div>

    <div id="achievement-toast">
        <div id="achievement-icon">üèÜ</div>
        <div id="achievement-details">
            <h4 id="achievement-title"></h4>
            <p id="achievement-desc"></p>
        </div>
    </div>
    
    <div id="timecard-popup" class="card">
        <h2 id="timecard-status"></h2>
        <p id="timecard-time"></p>
    </div>
    
    <script>
        window.onload = function() {
            // --- DOM ELEMENTS ---
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('month-year-header');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const summaryToday = document.getElementById('summary-today');
            const summaryPayPeriod = document.getElementById('summary-pay-period');
            const summaryTotal = document.getElementById('summary-total');
            const sidePanelContainer = document.getElementById('side-panel-container');
            const sidePanelBackdrop = document.getElementById('side-panel-backdrop');
            const closeSidePanelBtn = document.getElementById('close-side-panel-btn');
            const displaySelectedDate = document.getElementById('display-selected-date');
            const addSessionBtn = document.getElementById('add-session-btn');
            const sessionsDisplayArea = document.getElementById('sessions-display-area');
            const additionalHoursDisplayArea = document.getElementById('additional-hours-display-area');
            const displayDayTotal = document.getElementById('display-day-total');
            const noHoursMessage = document.getElementById('no-hours-message');
            const timeEntryModal = document.getElementById('time-entry-modal');
            const closeEntryModalBtn = document.getElementById('close-entry-modal-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalSelectedDate = document.getElementById('modal-selected-date');
            const timeInInput = document.getElementById('time-in');
            const timeOutInput = document.getElementById('time-out');
            const timeInContainer = document.getElementById('time-in-container');
            const timeOutContainer = document.getElementById('time-out-container');
            const hourTypeContainer = document.getElementById('hour-type-container');
            const additionalHoursInput = document.getElementById('additional-hours');
            const additionalHoursContainer = document.getElementById('additional-hours-container');
            const hourTypeButtons = document.querySelectorAll('.hour-type-btn');
            const saveBtn = document.getElementById('save-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
            const settingsModal = document.getElementById('settings-modal');
            const themeSelect = document.getElementById('theme-select');
            const backgroundSelect = document.getElementById('background-select');
            const payPeriodSelect = document.getElementById('pay-period-select');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const notificationToast = document.getElementById('notification-toast');
            const notificationMessage = document.getElementById('notification-message');
            const turnInHoursBtn = document.getElementById('turn-in-hours-btn');
            const timesheetModal = document.getElementById('timesheet-modal');
            const closeTimesheetModalBtn = document.getElementById('close-timesheet-modal-btn');
            const closeTimesheetBtnBottom = document.getElementById('close-timesheet-btn-bottom');
            const timesheetOutput = document.getElementById('timesheet-output');
            const copyTimesheetBtn = document.getElementById('copy-timesheet-btn');
            const clockInBtn = document.getElementById('clock-in-btn');
            const clockOutBtn = document.getElementById('clock-out-btn');
            const clockOutTypeModal = document.getElementById('clock-out-type-modal');
            const confirmAcapBtn = document.getElementById('confirm-acap-btn');
            const confirmCoreBtn = document.getElementById('confirm-core-btn');
            const clockOutCancelBtn = document.getElementById('clock-out-cancel-btn');
            const backgroundContainer = document.getElementById('background-animation-container');
            const viewStatsBtn = document.getElementById('view-stats-btn');
            const statsModal = document.getElementById('stats-modal');
            const closeStatsModalBtn = document.getElementById('close-stats-modal-btn');
            const weeklyHoursCtx = document.getElementById('weekly-hours-chart').getContext('2d');
            const typeBreakdownCtx = document.getElementById('type-breakdown-chart').getContext('2d');
            const statsNoDataMessage = document.getElementById('stats-no-data-message');
            const achievementToast = document.getElementById('achievement-toast');
            const achievementTitle = document.getElementById('achievement-title');
            const achievementDesc = document.getElementById('achievement-desc');
            const splashScreen = document.getElementById('splash-screen');
            const splashTitle = document.getElementById('splash-title');
            const splashStartBtn = document.getElementById('splash-start-btn');
            const timecardPopup = document.getElementById('timecard-popup');
            const timecardStatus = document.getElementById('timecard-status');
            const timecardTime = document.getElementById('timecard-time');

            // --- STATE MANAGEMENT ---
            let currentDate = new Date();
            let selectedDate = null;
            let editingSessionIndex = -1;
            let timeData = {};
            let settings = { theme: 'Parchment', background: 'none', payPeriod: 14 };
            let modalHourType = 'CORE';
            let onConfirmCallback = null;
            let notificationTimeout;
            let weeklyChartInstance = null;
            let typeChartInstance = null;
            let unlockedAchievements = {};
            let achievementQueue = [];
            let isDisplayingAchievement = false;
            let audioContext;
            let autoStartTimer;

            // --- AUDIO INITIALIZATION & PLAYBACK ---
            function initAudio() {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const unlockAudio = () => {
                        if (audioContext.state === 'suspended') {
                            audioContext.resume();
                        }
                        document.body.removeEventListener('click', unlockAudio);
                        document.body.removeEventListener('touchend', unlockAudio);
                    };
                    document.body.addEventListener('click', unlockAudio);
                    document.body.addEventListener('touchend', unlockAudio);
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser.");
                }
            }
            
            function playTone(frequency, startTime, duration, volume = 0.2) {
                if (!audioContext || audioContext.state !== 'running') return;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime + startTime);
                
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime + startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + startTime + duration);

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start(audioContext.currentTime + startTime);
                oscillator.stop(audioContext.currentTime + startTime + duration);
            }

            function playAchievementSound() {
                playTone(880, 0, 0.5, 0.3);
            }
            
            function playClockInSound() {
                playTone(523.25, 0, 0.1); // C5
                playTone(659.25, 0.1, 0.15); // E5
            }

            function playClockOutSound() {
                playTone(659.25, 0, 0.1); // E5
                playTone(523.25, 0.1, 0.15); // C5
            }

            function playTurnInSound() {
                playTone(523.25, 0, 0.1);    // C5
                playTone(659.25, 0.1, 0.1);  // E5
                playTone(783.99, 0.2, 0.15); // G5
            }


            // --- HELPER FUNCTIONS ---
            function getDateString(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
            function getExactTime(date) { return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; }
            
            function formatTo12Hour(timeString) {
                if (!timeString || timeString.includes('M')) return timeString || '--:--';
                const [hours, minutes] = timeString.split(':');
                const h = parseInt(hours, 10);
                const ampm = h >= 12 ? 'PM' : 'AM';
                let h12 = h % 12;
                if (h12 === 0) h12 = 12; // For 12 AM and 12 PM
                return `${h12}:${minutes} ${ampm}`;
            }

            function roundTimeString(timeString) {
                if (!timeString) return '';
                const [hours, minutes] = timeString.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes;
                const roundedMinutes = Math.round(totalMinutes / 15) * 15;
                const newHours = Math.floor(roundedMinutes / 60);
                const newMinutes = roundedMinutes % 60;
                const finalHours = newHours % 24;
                return `${String(finalHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
            }
            function getDayWithSuffix(d) {
                const day = d.getDate();
                if (day > 3 && day < 21) return day + 'th';
                switch (day % 10) {
                    case 1: return day + "st";
                    case 2: return day + "nd";
                    case 3: return day + "rd";
                    default: return day + "th";
                }
            }

            // --- THEME & BACKGROUND MANAGEMENT ---
            const themes = {
                Parchment: { '--bg-primary': '#F3EAD3', '--bg-secondary': '#FFFFFF', '--text-primary': '#4A4A4A', '--text-secondary': '#7A7A7A', '--accent-primary': '#86A8E7', '--accent-secondary': '#91EAE4', '--border-default': '#D9D9D9' },
                Oceanic: { '--bg-primary': '#0B2027', '--bg-secondary': '#12343B', '--text-primary': '#E0FBFC', '--text-secondary': '#96C5D9', '--accent-primary': '#3EF7B2', '--accent-secondary': '#00B4D8', '--border-default': 'rgba(150, 197, 217, 0.4)' },
                Sakura: { '--bg-primary': '#F9F1F1', '--bg-secondary': '#FFFFFF', '--text-primary': '#5B4242', '--text-secondary': '#8D6E6E', '--accent-primary': '#E6A4B4', '--accent-secondary': '#FFB7C5', '--border-default': '#E6DEDE' },
                Twilight: { '--bg-primary': '#232526', '--bg-secondary': '#414345', '--text-primary': '#E0E0E0', '--text-secondary': '#BDBDBD', '--accent-primary': '#8E44AD', '--accent-secondary': '#9B59B6', '--border-default': '#616161' },
                'Minty Fresh': { '--bg-primary': '#E0F2F1', '--bg-secondary': '#FFFFFF', '--text-primary': '#004D40', '--text-secondary': '#00796B', '--accent-primary': '#4DB6AC', '--accent-secondary': '#80CBC4', '--border-default': '#B2DFDB' },
                'Lavender Dream': { '--bg-primary': '#EAE6F0', '--bg-secondary': '#FFFFFF', '--text-primary': '#4B3F5B', '--text-secondary': '#7A6A89', '--accent-primary': '#C3AED6', '--accent-secondary': '#D8BFD8', '--border-default': '#DCD0E3' },
                'Misty Forest': { '--bg-primary': '#D8E2DC', '--bg-secondary': '#FFFFFF', '--text-primary': '#3A4F41', '--text-secondary': '#6B8A7A', '--accent-primary': '#A3B8A6', '--accent-secondary': '#C2D1C5', '--border-default': '#C4CEC8' },
                'Golden Hour': { '--bg-primary': '#FFF3E0', '--bg-secondary': '#FFFFFF', '--text-primary': '#6D4C41', '--text-secondary': '#9E786B', '--accent-primary': '#FFCC80', '--accent-secondary': '#FFE0B2', '--border-default': '#FFE9D4' },
                'Coral Reef': { '--bg-primary': '#E0F7FA', '--bg-secondary': '#FFFFFF', '--text-primary': '#004C5A', '--text-secondary': '#007A8A', '--accent-primary': '#4DD0E1', '--accent-secondary': '#80DEEA', '--border-default': '#B2EBF2' },
                'Cozy Cabin': { '--bg-primary': '#EFEBE9', '--bg-secondary': '#FFFFFF', '--text-primary': '#5D4037', '--text-secondary': '#8D6E63', '--accent-primary': '#A1887F', '--accent-secondary': '#BCAAA4', '--border-default': '#D7CCC8' },
            };
            function applyTheme(themeName) { const t = themes[themeName]; if (!t) return; Object.keys(t).forEach(k => document.documentElement.style.setProperty(k, t[k])); settings.theme = themeName; saveSettings(); }
            function populateThemeSelector() { Object.keys(themes).forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; themeSelect.appendChild(o); }); }
            
            function applyBackground(name) {
                backgroundContainer.innerHTML = ''; // Clear previous background
                document.body.classList.remove('animated-gradient');
                backgroundContainer.style.backgroundColor = 'transparent'; // Reset container background

                if (name === 'gradient') {
                    document.body.classList.add('animated-gradient');
                } else if (name === 'orbs') {
                    for (let i = 0; i < 20; i++) {
                        const orb = document.createElement('div');
                        orb.className = 'orb';
                        const size = Math.random() * 150 + 50;
                        orb.style.width = `${size}px`;
                        orb.style.height = `${size}px`;
                        orb.style.left = `${Math.random() * 100}vw`;
                        orb.style.animationDuration = `${Math.random() * 20 + 15}s`;
                        orb.style.animationDelay = `${Math.random() * 10}s`;
                        backgroundContainer.appendChild(orb);
                    }
                } else if (name === 'stars') {
                    backgroundContainer.style.backgroundColor = '#0B2027'; // Set container background to dark blue
                    for (let i = 0; i < 100; i++) {
                        const star = document.createElement('div');
                        star.className = 'star';
                        const size = Math.random() * 2 + 1;
                        star.style.width = `${size}px`;
                        star.style.height = `${size}px`;
                        star.style.top = `${Math.random() * 100}%`;
                        star.style.left = `${Math.random() * 100}%`;
                        star.style.animationDuration = `${Math.random() * 3 + 2}s`;
                        star.style.animationDelay = `${Math.random() * 5}s`;
                        backgroundContainer.appendChild(star);
                    }
                }

                settings.background = name;
                saveSettings();
            }

            // --- SIDE PANEL & MODAL ---
            function openSidePanel() { sidePanelContainer.classList.add('active'); }
            function closeSidePanel() { sidePanelContainer.classList.remove('active'); }
            function openTimeEntryModal(dateStr, sessionIndex = -1) { editingSessionIndex = sessionIndex; loadEntryForModal(dateStr, sessionIndex); timeEntryModal.classList.add('active'); }
            function closeTimeEntryModal() { timeEntryModal.classList.remove('active'); }

            // --- CALENDAR LOGIC ---
            function renderCalendar() {
                calendarGrid.innerHTML = '';
                const month = currentDate.getMonth();
                const year = currentDate.getFullYear();
                monthYearHeader.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => { const e = document.createElement('div'); e.className = 'font-bold text-secondary text-sm py-2'; e.textContent = d; calendarGrid.appendChild(e); });
                const firstDay = new Date(year, month, 1).getDay();
                for (let i = 0; i < firstDay; i++) calendarGrid.appendChild(document.createElement('div'));
                
                for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    const dayEl = document.createElement('button');
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    dayEl.textContent = day;
                    dayEl.className = 'p-2 rounded-lg transition-all duration-200 aspect-square flex items-center justify-center border';
                    
                    if (selectedDate === dateStr) {
                        dayEl.classList.add('border-2');
                        dayEl.style.borderColor = 'var(--accent-primary)';
                    } else {
                        dayEl.style.borderColor = 'var(--border-default)';
                    }

                    if (timeData[dateStr] && calculateHours(dateStr) > 0) {
                        dayEl.classList.add('font-bold');
                        dayEl.style.backgroundColor = 'var(--accent-secondary)';
                        dayEl.style.color = 'white';
                    }
                    
                    const today = new Date();
                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayEl.classList.add('font-extrabold');
                    }
                    
                    dayEl.addEventListener('click', () => {
                        selectedDate = dateStr;
                        updateDisplayPanel(dateStr);
                        renderCalendar();
                        if (calculateHours(dateStr) > 0) { openSidePanel(); } 
                        else { openTimeEntryModal(dateStr, -1); }
                    });
                    calendarGrid.appendChild(dayEl);
                }
            }

            // --- UI & DATA FLOW ---
            function updateDisplayPanel(dateStr) {
                const entry = timeData[dateStr] || { sessions: [], additional: 0 };
                const dateObj = new Date(`${dateStr}T00:00:00Z`);
                displaySelectedDate.textContent = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                sessionsDisplayArea.innerHTML = '';
                additionalHoursDisplayArea.innerHTML = '';
                const hasHours = calculateHours(dateStr) > 0;
                noHoursMessage.classList.toggle('hidden', !hasHours);
                addSessionBtn.classList.toggle('hidden', !dateStr);
                if (hasHours) {
                    entry.sessions.forEach((session, index) => {
                        const sEl = document.createElement('div');
                        sEl.className = 'p-3 rounded-lg flex items-center gap-2'; sEl.style.backgroundColor = 'var(--bg-primary)';
                        sEl.innerHTML = `<div class="flex-grow"><div class="flex justify-between items-center text-sm"><span>${formatTo12Hour(session.in)} - ${formatTo12Hour(session.out) || '...'}</span><span class="font-bold">${session.type || 'N/A'}</span></div></div>`;
                        const ctrls = document.createElement('div'); ctrls.className = 'flex items-center';
                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                        editBtn.className = 'p-1 hover:text-blue-500'; editBtn.title = "Edit Session";
                        editBtn.onclick = () => openTimeEntryModal(dateStr, index);
                        const delBtn = document.createElement('button');
                        delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                        delBtn.className = 'p-1 hover:text-red-500'; delBtn.title = "Delete Session";
                        delBtn.onclick = () => deleteSession(dateStr, index);
                        ctrls.appendChild(editBtn); ctrls.appendChild(delBtn);
                        sEl.appendChild(ctrls);
                        sessionsDisplayArea.appendChild(sEl);
                    });
                    const addEl = document.createElement('div');
                    addEl.className = "flex justify-between items-center p-3 rounded-lg"; addEl.style.backgroundColor = 'var(--bg-primary)';
                    addEl.innerHTML = `<div class="flex-grow"><div class="flex justify-between items-center text-sm"><span>Additional Hours:</span><span class="font-bold">${(entry.additional || 0).toFixed(2)}h</span></div></div>`;
                    const editAddBtn = document.createElement('button');
                    editAddBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                    editAddBtn.className = 'p-1 hover:text-blue-500 ml-2'; editAddBtn.title = "Edit Additional Hours";
                    editAddBtn.onclick = () => openTimeEntryModal(dateStr, 'additional');
                    addEl.appendChild(editAddBtn);
                    additionalHoursDisplayArea.appendChild(addEl);
                }
                displayDayTotal.textContent = `${calculateHours(dateStr).toFixed(2)}h`;
            }

            function updateHourTypeSelectionUI() { hourTypeButtons.forEach(b => { b.classList.toggle('btn-primary', b.dataset.type === modalHourType); b.classList.toggle('btn-secondary', b.dataset.type !== modalHourType); }); }

            function loadEntryForModal(dateStr, sessionIndex) {
                const entry = timeData[dateStr] || { sessions: [], additional: 0 };
                const dateObj = new Date(`${dateStr}T00:00:00Z`);
                modalSelectedDate.textContent = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const isAdd = sessionIndex === 'additional';
                additionalHoursContainer.classList.toggle('hidden', !isAdd);
                timeInContainer.classList.toggle('hidden', isAdd);
                timeOutContainer.classList.toggle('hidden', isAdd);
                hourTypeContainer.classList.toggle('hidden', isAdd);
                if (isAdd) { modalTitle.textContent = "Edit Additional Hours"; additionalHoursInput.value = entry.additional || ''; } 
                else if (sessionIndex >= 0 && entry.sessions[sessionIndex]) { const s = entry.sessions[sessionIndex]; modalTitle.textContent = "Edit Session"; timeInInput.value = s.in || ''; timeOutInput.value = s.out || ''; modalHourType = s.type || 'CORE'; } 
                else { modalTitle.textContent = "Add New Session"; timeInInput.value = ''; timeOutInput.value = ''; additionalHoursInput.value = ''; modalHourType = 'CORE'; }
                updateHourTypeSelectionUI();
            }

            function saveEntry() {
                if (!selectedDate) return;
                if (!timeData[selectedDate]) timeData[selectedDate] = { sessions: [], additional: 0 };
                if (editingSessionIndex === 'additional') { timeData[selectedDate].additional = parseFloat(additionalHoursInput.value) || 0; } 
                else if (editingSessionIndex >= 0) { timeData[selectedDate].sessions[editingSessionIndex] = { in: timeInInput.value, out: timeOutInput.value, type: modalHourType }; } 
                else { timeData[selectedDate].sessions.push({ in: timeInInput.value, out: timeOutInput.value, type: modalHourType }); }
                showNotification('Hours saved!');
                saveData(); updateAllUI();
                checkAllAchievements({ date: selectedDate });
                setTimeout(closeTimeEntryModal, 400); 
            }
            
            function deleteSession(dateStr, index) {
                showConfirm("Delete this session?", () => {
                   if(timeData[dateStr] && timeData[dateStr].sessions[index]) {
                       timeData[dateStr].sessions.splice(index, 1);
                       showNotification('Session deleted.');
                       saveData(); updateAllUI();
                   }
                });
            }

            function calculateHours(dateStr) {
                const e = timeData[dateStr]; if (!e) return 0;
                let dur = e.sessions ? e.sessions.reduce((t, s) => { if (s.in && s.out) { const i = new Date(`${dateStr}T${s.in}`); const o = new Date(`${dateStr}T${s.out}`); if (o > i) return t + (o - i) / 3600000; } return t; }, 0) : 0;
                return dur + (e.additional || 0);
            }

            function updateAllUI() { renderCalendar(); updateSummaries(); if(selectedDate) updateDisplayPanel(selectedDate); }

            function updateSummaries() {
                const todayStr = getDateString(new Date());
                summaryToday.textContent = `${calculateHours(todayStr).toFixed(2)}h`;
                summaryTotal.textContent = `${Object.keys(timeData).reduce((a, d) => a + calculateHours(d), 0).toFixed(2)}h`;
                let periodHours = 0; const today = new Date();
                // This summary shows the current pay period setting, not the fixed two weeks for the timesheet.
                for (let i = 0; i < settings.payPeriod; i++) {
                    const date = new Date(today); date.setDate(today.getDate() - i);
                    periodHours += calculateHours(getDateString(date));
                }
                summaryPayPeriod.textContent = `${periodHours.toFixed(2)}h`;
            }
            
            function generateAndShowTimesheet() {
                // A known pay period started on Sat, July 5, 2025. All 2-week periods are relative to this.
                const refStartDate = new Date('2025-07-05T00:00:00');
                const today = new Date();
                const periodDuration = 14; // Always 2 weeks
                const msPerDay = 1000 * 60 * 60 * 24;

                // Find which 14-day period we are currently in, relative to the reference start date.
                const daysSinceRef = Math.floor((today - refStartDate) / msPerDay);
                const periodNum = Math.floor(daysSinceRef / periodDuration);
                
                // Calculate the start and end dates of the current pay period.
                const periodStartDate = new Date(refStartDate);
                periodStartDate.setDate(refStartDate.getDate() + (periodNum * periodDuration));
                
                const periodEndDate = new Date(periodStartDate);
                periodEndDate.setDate(periodStartDate.getDate() + (periodDuration - 1));

                let timesheetLines = [];
                let acapTotal = 0;
                let coreTotal = 0;

                for (let d = new Date(periodStartDate); d <= periodEndDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = getDateString(d);
                    const entry = timeData[dateStr];
                    const dayOfWeekStr = d.toLocaleDateString('en-US', { weekday: 'short' });
                    const month = d.toLocaleDateString('en-US', { month: 'short' });
                    const dayWithSuffix = getDayWithSuffix(d);
                    const baseLine = `${dayOfWeekStr} ${dayWithSuffix} - ${month}`;

                    let dayHasContent = false;
                    
                    if (entry && entry.sessions && entry.sessions.length > 0) {
                        entry.sessions.forEach(session => {
                            if (session.in && session.out) {
                                const roundedIn = roundTimeString(session.in);
                                const roundedOut = roundTimeString(session.out);
                                
                                const inDate = new Date(`${dateStr}T${roundedIn}`);
                                let outDate = new Date(`${dateStr}T${roundedOut}`);

                                if (outDate < inDate) { outDate.setDate(outDate.getDate() + 1); }
                                
                                const sessionHours = (outDate - inDate) / 3600000;

                                if (sessionHours > 0) {
                                    timesheetLines.push(`${baseLine} ${formatTo12Hour(roundedIn)} - ${formatTo12Hour(roundedOut)} ${sessionHours.toFixed(2)} ${session.type || 'CORE'}`);
                                    if (session.type === 'ACAP') {
                                        acapTotal += sessionHours;
                                    } else {
                                        coreTotal += sessionHours;
                                    }
                                    dayHasContent = true;
                                }
                            }
                        });
                    }

                    if (!dayHasContent) {
                        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                        if (isWeekend) {
                            timesheetLines.push(`${baseLine} - Closed`);
                        } else {
                            timesheetLines.push(baseLine);
                        }
                    }
                }

                const grandTotal = acapTotal + coreTotal;
                const summaryLines = [
                    '\nHere is the summary:\n',
                    `ACAP total: ${acapTotal.toFixed(2)} hours`,
                    `Core total: ${coreTotal.toFixed(2)} hours`,
                    `\nTotal: ${grandTotal.toFixed(2)} hours`
                ];

                timesheetOutput.value = timesheetLines.join('\n') + summaryLines.join('\n');
                timesheetModal.classList.add('active');
                showNotification("Timesheet generated for the current 2-week period.");
            }
            
            function showNotification(message) { clearTimeout(notificationTimeout); notificationMessage.textContent = message; notificationToast.classList.add('show'); notificationTimeout = setTimeout(() => notificationToast.classList.remove('show'), 3000); }
            function showConfirm(message, onConfirm) { confirmMessage.textContent = message; onConfirmCallback = onConfirm; confirmModal.classList.add('active'); }
            
            function showTimecard(status, time) {
                timecardStatus.textContent = status;
                timecardTime.textContent = time;
                timecardPopup.classList.add('show');
                setTimeout(() => {
                    timecardPopup.classList.remove('show');
                }, 2500); // Display for 2.5 seconds
            }

            // --- ACHIEVEMENT SYSTEM ---
            const achievements = {
                firstClockIn: { title: "Early Bird", desc: "You clocked in for the first time!", check: () => Object.keys(timeData).length > 0 },
                firstClockOut: { title: "And... Scene!", desc: "You finished your first session!", check: () => Object.values(timeData).some(d => d.sessions && d.sessions.some(s => s.in && s.out)) },
                weekly10: { title: "Getting Warmed Up", desc: "You worked 10 hours in a week!", check: () => getWeekHours(new Date()) >= 10 },
                weekly20: { title: "Part-Time Pro", desc: "You worked 20 hours in a week!", check: () => getWeekHours(new Date()) >= 20 },
                weekly40: { title: "Full-Time Hero", desc: "You worked 40 hours in a week!", check: () => getWeekHours(new Date()) >= 40 },
                firstPayPeriod: { title: "First Paycheck!", desc: "You completed your first pay period!", check: () => hasCompletedPayPeriod() },
                oneMonth: { title: "Monthly Milestone", desc: "You've been tracking for a month!", check: () => checkDuration(30) },
                sixMonths: { title: "Half-Year Hustler", desc: "Six months of hard work!", check: () => checkDuration(182) },
                oneYear: { title: "Anniversary Ace", desc: "A full year of dedication!", check: () => checkDuration(365) },
                shortShift: { title: "Quick Trip", desc: "Worked for less than an hour.", check: (data) => data?.lastSessionHours > 0 && data.lastSessionHours < 1 },
                bothTypes: { title: "Jack of All Trades", desc: "Logged both CORE and ACAP in one day!", check: (data) => {
                    if (!data?.date) return false;
                    const entry = timeData[data.date];
                    if (!entry || !entry.sessions) return false;
                    const types = new Set(entry.sessions.map(s => s.type));
                    return types.has('CORE') && types.has('ACAP');
                }},
            };

            function getWeekHours(refDate) {
                let total = 0;
                const startOfWeek = new Date(refDate);
                startOfWeek.setDate(refDate.getDate() - refDate.getDay()); // Sunday
                for(let i=0; i<7; i++) {
                    const day = new Date(startOfWeek);
                    day.setDate(startOfWeek.getDate() + i);
                    total += calculateHours(getDateString(day));
                }
                return total;
            }

            function hasCompletedPayPeriod() {
                const refStartDate = new Date('2025-07-05T00:00:00');
                const today = new Date();
                const msPerDay = 1000 * 60 * 60 * 24;
                const daysSinceRef = Math.floor((today - refStartDate) / msPerDay);
                const periodNum = Math.floor(daysSinceRef / 14);
                if (periodNum < 1) return false; // Must be at least in the second pay period
                
                const prevPeriodStartDate = new Date(refStartDate);
                prevPeriodStartDate.setDate(refStartDate.getDate() + ((periodNum - 1) * 14));
                let prevPeriodHours = 0;
                for (let i = 0; i < 14; i++) {
                    const date = new Date(prevPeriodStartDate);
                    date.setDate(prevPeriodStartDate.getDate() + i);
                    prevPeriodHours += calculateHours(getDateString(date));
                }
                return prevPeriodHours > 0;
            }

            function checkDuration(days) {
                const dateKeys = Object.keys(timeData);
                if (dateKeys.length === 0) return false;
                const firstDate = new Date(dateKeys.sort()[0]);
                const diff = (new Date() - firstDate) / (1000 * 60 * 60 * 24);
                return diff >= days;
            }

            function checkAllAchievements(eventData, isInitialLoad = false) {
                Object.keys(achievements).forEach(id => {
                    if (!unlockedAchievements[id] && achievements[id].check(eventData)) {
                        unlockAchievement(id, !isInitialLoad);
                    }
                });
            }

            function unlockAchievement(id, playSound = true) {
                unlockedAchievements[id] = true;
                achievementQueue.push({ id, playSound });
                processAchievementQueue();
                saveData();
            }

            function processAchievementQueue() {
                if (isDisplayingAchievement || achievementQueue.length === 0) return;
                isDisplayingAchievement = true;
                
                const { id, playSound } = achievementQueue.shift();
                const achievement = achievements[id];

                achievementTitle.textContent = achievement.title;
                achievementDesc.textContent = achievement.desc;
                achievementToast.classList.add('show');
                
                if (playSound) {
                    playAchievementSound();
                }
                
                setTimeout(() => {
                    achievementToast.classList.remove('show');
                    setTimeout(() => {
                        isDisplayingAchievement = false;
                        processAchievementQueue();
                    }, 500);
                }, 4000);
            }

            // --- LOCAL STORAGE ---
            function saveData() { 
                localStorage.setItem('timeTrackerData', JSON.stringify(timeData)); 
                localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedAchievements));
            }
            function loadData() { 
                const d = localStorage.getItem('timeTrackerData'); 
                if (d) timeData = JSON.parse(d); 
                const a = localStorage.getItem('unlockedAchievements');
                if (a) unlockedAchievements = JSON.parse(a);
            }
            function saveSettings() { localStorage.setItem('timeTrackerSettings', JSON.stringify(settings)); }
            function loadSettings() { const s = localStorage.getItem('timeTrackerSettings'); if (s) settings = {...settings, ...JSON.parse(s)}; }
            function clearAllData() { showConfirm('Delete all entries and achievements?', () => { 
                timeData = {}; 
                unlockedAchievements = {};
                saveData(); updateAllUI(); showNotification('All data cleared.'); }); 
            }

            // --- EVENT LISTENERS ---
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            addSessionBtn.addEventListener('click', () => { openTimeEntryModal(selectedDate, -1); closeSidePanel(); });
            saveBtn.addEventListener('click', saveEntry);
            closeEntryModalBtn.addEventListener('click', closeTimeEntryModal);
            closeSidePanelBtn.addEventListener('click', closeSidePanel);
            sidePanelBackdrop.addEventListener('click', closeSidePanel);
            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            confirmOkBtn.addEventListener('click', () => { if (onConfirmCallback) onConfirmCallback(); confirmModal.classList.remove('active'); onConfirmCallback = null; });
            confirmCancelBtn.addEventListener('click', () => { confirmModal.classList.remove('active'); onConfirmCallback = null; });
            themeSelect.addEventListener('change', e => applyTheme(e.target.value));
            backgroundSelect.addEventListener('change', e => applyBackground(e.target.value));
            payPeriodSelect.addEventListener('change', e => { settings.payPeriod = parseInt(e.target.value, 10); saveSettings(); updateSummaries(); });
            clearDataBtn.addEventListener('click', clearAllData);
            hourTypeButtons.forEach(b => { b.addEventListener('click', () => { modalHourType = b.dataset.type; updateHourTypeSelectionUI(); }); });
            
            turnInHoursBtn.addEventListener('click', () => {
                generateAndShowTimesheet();
                playTurnInSound();
            });
            
            copyTimesheetBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(timesheetOutput.value)
                    .then(() => {
                        showNotification('Timesheet copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Could not copy text: ', err);
                        showNotification('Failed to copy. Please copy manually.');
                    });
            });

            const closeSheet = () => timesheetModal.classList.remove('active');
            closeTimesheetModalBtn.addEventListener('click', closeSheet);
            closeTimesheetBtnBottom.addEventListener('click', closeSheet);
            timesheetModal.addEventListener('click', (e) => { if (e.target === timesheetModal) closeSheet(); });
            viewStatsBtn.addEventListener('click', () => { renderCharts(); statsModal.classList.add('active'); });
            closeStatsModalBtn.addEventListener('click', () => statsModal.classList.remove('active'));

            clockInBtn.addEventListener('click', () => {
                const now = new Date(); 
                const todayStr = getDateString(now);
                if (!timeData[todayStr]) timeData[todayStr] = { sessions: [], additional: 0 };
                if (timeData[todayStr].sessions.find(s => s.in && !s.out)) { showNotification('You are already clocked in.'); return; }
                const exactTime = getExactTime(now);
                timeData[todayStr].sessions.push({ in: exactTime });
                selectedDate = todayStr;
                saveData(); updateAllUI();
                showTimecard('Clocked In', formatTo12Hour(exactTime));
                playClockInSound();
                checkAllAchievements();
            });

            clockOutBtn.addEventListener('click', () => {
                const todayStr = getDateString(new Date());
                if (!timeData[todayStr]?.sessions.find(s => s.in && !s.out)) { showNotification('You are not clocked in.'); return; }
                clockOutTypeModal.classList.add('active');
            });
            
            function handleClockOutWithType(type) {
                const now = new Date();
                const todayStr = getDateString(now);
                const openSessionIdx = timeData[todayStr].sessions.findIndex(s => s.in && !s.out);
                if (openSessionIdx > -1) {
                    const exactTime = getExactTime(now);
                    const session = timeData[todayStr].sessions[openSessionIdx];
                    session.out = exactTime;
                    session.type = type;
                    selectedDate = todayStr;

                    const inDate = new Date(`${todayStr}T${session.in}`);
                    const outDate = new Date(`${todayStr}T${session.out}`);
                    const lastSessionHours = (outDate > inDate) ? (outDate - inDate) / 3600000 : 0;
                    
                    saveData(); updateAllUI();
                    clockOutTypeModal.classList.remove('active');
                    showTimecard('Clocked Out', formatTo12Hour(exactTime));
                    playClockOutSound();
                    checkAllAchievements({ lastSessionHours: lastSessionHours, date: todayStr });
                }
            }

            confirmAcapBtn.addEventListener('click', () => handleClockOutWithType('ACAP'));
            confirmCoreBtn.addEventListener('click', () => handleClockOutWithType('CORE'));
            clockOutCancelBtn.addEventListener('click', () => clockOutTypeModal.classList.remove('active'));

            function renderCharts() {
                if (weeklyChartInstance) weeklyChartInstance.destroy();
                if (typeChartInstance) typeChartInstance.destroy();

                const dateKeys = Object.keys(timeData).sort();
                const hasData = dateKeys.length > 0;
                statsNoDataMessage.classList.toggle('hidden', hasData);

                if(!hasData) return;

                // Weekly Hours Chart
                const last12Weeks = [];
                for (let i = 11; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - (i * 7));
                    last12Weeks.push({
                        label: `Week of ${d.getMonth()+1}/${d.getDate()}`,
                        hours: getWeekHours(d)
                    });
                }
                weeklyChartInstance = new Chart(weeklyHoursCtx, {
                    type: 'bar',
                    data: {
                        labels: last12Weeks.map(w => w.label),
                        datasets: [{
                            label: 'Weekly Hours',
                            data: last12Weeks.map(w => w.hours.toFixed(2)),
                            backgroundColor: 'rgba(134, 168, 231, 0.5)',
                            borderColor: 'rgba(134, 168, 231, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    }
                });
                
                // Type Breakdown Chart
                let coreHours = 0, acapHours = 0;
                Object.values(timeData).forEach(day => {
                    day.sessions.forEach(s => {
                        if (s.in && s.out) {
                            const i = new Date(`1970-01-01T${s.in}`);
                            const o = new Date(`1970-01-01T${s.out}`);
                            const hours = (o > i) ? (o - i) / 3600000 : 0;
                            if (s.type === 'ACAP') acapHours += hours;
                            else coreHours += hours;
                        }
                    });
                });

                typeChartInstance = new Chart(typeBreakdownCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['CORE', 'ACAP'],
                        datasets: [{
                            data: [coreHours, acapHours],
                            backgroundColor: ['rgba(145, 234, 228, 0.7)', 'rgba(134, 168, 231, 0.7)'],
                            borderColor: ['#91EAE4', '#86A8E7'],
                            borderWidth: 2
                        }]
                    },
                     options: { responsive: true, maintainAspectRatio: true }
                });
            }
            
            // --- SPLASH SCREEN LOGIC ---
            function hideSplashScreen() {
                clearTimeout(autoStartTimer);
                splashScreen.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 500);
            }

            function showSplashScreen() {
                const titleText = "Hours for Shelby";
                titleText.split('').forEach((char, index) => {
                    const span = document.createElement('span');
                    span.textContent = char === ' ' ? '\u00A0' : char;
                    span.style.animationDelay = `${index * 0.05}s`;
                    splashTitle.appendChild(span);
                });

                setTimeout(() => {
                    const cog = document.querySelector('.splash-cog');
                    const face = document.querySelector('.splash-clock-face');
                    const hands = document.querySelector('.splash-clock-hands');
                    const minuteHand = document.querySelector('.minute-hand');
                    const hourHand = document.querySelector('.hour-hand');

                    cog.classList.add('fade-out');
                    face.classList.add('fade-in');
                    hands.classList.add('fade-in');
                    
                    setTimeout(() => {
                        minuteHand.classList.add('spinning');
                        hourHand.classList.add('spinning');
                    }, 500);

                }, 1500);

                autoStartTimer = setTimeout(hideSplashScreen, 5000);
                splashStartBtn.addEventListener('click', hideSplashScreen);
            }

            // --- INITIALIZATION ---
            function init() {
                showSplashScreen();
                initAudio();
                loadSettings(); 
                loadData();
                populateThemeSelector();
                themeSelect.value = settings.theme; 
                applyTheme(settings.theme);
                backgroundSelect.value = settings.background; 
                applyBackground(settings.background);
                payPeriodSelect.value = settings.payPeriod;
                selectedDate = getDateString(new Date());
                updateAllUI();
                checkAllAchievements({}, true); 
            }

            init();
        };
    </script>
</body>
</html>
